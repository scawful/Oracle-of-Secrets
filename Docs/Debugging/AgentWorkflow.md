# Agent Workflow (Lean)

Use this file only when the one-page `Docs/Debugging/Agent/Quickstart.md` is not enough. The goal is to keep every agent on the same minimal path.

## Core stack (preferred)
- Emulator: `/Applications/Mesen2 OOS.app` (fork with socket auto-start).
- Client: `python3 scripts/mesen2_client.py` (auto-attaches only if a single socket exists; otherwise set `MESEN2_SOCKET_PATH` or use `--socket`/`--instance`).
- Build: `./scripts/build_rom.sh 168` (or version from ROM name).
- States: `mesen2_client.py` state library (`library`, `lib-load`, `lib-save`) + `lib-verify-all` guardrail.

## Five commands you actually need
```
python3 scripts/mesen2_client.py run-state
python3 scripts/mesen2_client.py diagnostics --json
python3 scripts/mesen2_client.py smart-save 5 --label "<bug>"
python3 scripts/mesen2_client.py lib-save "<bug>"
python3 scripts/mesen2_client.py watch --profile overworld
```
Other quick hits: `press`, `move`, `state-diff`, `labels-sync`, `capture --json`.

## Baseline loop (GUI)
1. Build ROM; open in Mesen2 (socket ready).
2. Run the five commands above to preflight and capture.
3. Debug with `watch` + `press/move`; keep notes in `.context/.../agent_handoff.md` or `Docs/Debugging/Issues/`.
4. Re-run `lib-verify-all` after ROM rebuilds.

## Headless / CI (when GUI is impossible)
- Use `./scripts/mesen2_launch_instance.sh --headless --instance <name> --source ci --owner agent`.
- Prefer socket control (`mesen2_client.py`) with deterministic `MESEN2_SOCKET_PATH`/`--instance` when headless.

## Paths that matter
- ROMs: `Roms/`
- Saves: `Roms/SaveStates/`
- Labels: keep `<rom>.mlb` next to the ROM (export via yaze or `export_symbols.py`).
- Stability references: `Docs/STABILITY.md` (color math clears, SPC timeouts, input hygiene).

## Module + feature isolation (guardrails)
When debugging regressions, prefer toggling modules/features instead of commenting out code.

### Modules (coarse)
- File: `Config/module_flags.asm` (generated by `scripts/set_module_flags.py`)
```
python3 scripts/set_module_flags.py --profile all --disable dungeon
python3 scripts/set_module_flags.py --profile all   # restore
```

### Features (fine)
- File: `Config/feature_flags.asm` (generated by `scripts/set_feature_flags.py`)
```
python3 scripts/set_feature_flags.py --list
python3 scripts/set_feature_flags.py --disable water_gate_hooks,water_gate_overlay_redirect
python3 scripts/set_feature_flags.py --profile defaults   # restore to Util/macros.asm defaults
```

Notes:
- `scripts/build_rom.sh` regenerates `hooks.json` automatically when flag files change, so z3dk analysis matches the built ROM.

## z3dk analyzer delta (baseline vs current)
Use this when you want to know what a change introduced (or fixed) without re-triaging all existing warnings.

```bash
python3 ../z3dk/scripts/oracle_analyzer.py Roms/oos168x_base.sfc --hooks hooks.json --json > /tmp/oos_an_base.json
python3 ../z3dk/scripts/oracle_analyzer.py Roms/oos168x.sfc      --hooks hooks.json --json > /tmp/oos_an_cur.json
python3 ../z3dk/scripts/oracle_analyzer_delta.py --baseline /tmp/oos_an_base.json --current /tmp/oos_an_cur.json
```

Build script note:
- `scripts/build_rom.sh` runs the analyzer automatically. By default it is **non-fatal**; set `OOS_ANALYSIS_FATAL=1` to block builds on analyzer errors.

## Sanity checks (rare but handy)
```
ls -ld /Applications/Mesen2\ OOS.app
./scripts/mesen2_sanity_check.sh --instance <name>   # checks socket + ROM alignment
```

## Optional helpers
- `python3 scripts/mesen2_client.py` or `scripts/mesen2_client_lib/bridge.py` for scripted socket access.
- `~/src/tools/hyrule-historian` for disasm/RAM lookups.
- `~/src/tools/expert-chain` only when you need multi-model analysis; otherwise avoid noise.
